#!/bin/sh
#
# Pre-commit hook to lint and test staged javascript files.
#
# Called with no arguments.

# Redirect output to stderr.
exec 1>&2

P="[git-hook]"

files=$(git diff --staged --name-only --diff-filter=ACM | grep ".js$")

#
# Continue if no changes in js files
#

if [ -z "$files" ]
then
    exit 0
fi

#
# Run linter
#

if ! [ -x ./node_modules/.bin/eslint ]
then
    echo -e "\033[31m$P eslint not found. aborting commit.\033[0m"
    exit 1
fi

echo "$P linting modified js files"
echo

for file in "$files"
do
    ./node_modules/.bin/eslint --cache "$file"
    if [ $? -ne 0 ]
    then
        echo -e "\033[31m$P lint failed: $file. aborting commit.\033[0m"
        exit 1
    fi
done


#
# Run unit tests
#

echo "$P running unit tests"
echo

make test

if [ $? -ne 0 ]
then
    echo -e "\033[31m$P test failed. aborting commit.\033[0m"
    exit 1
fi

exit 0
